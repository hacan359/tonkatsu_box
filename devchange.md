# Журнал изменений разработки

Этот документ содержит решения, принятые во время разработки, которые отличаются от первоначального плана или содержат важные архитектурные решения.

---

## Stage 4: Progress Tracking (2026-02-05)

### Изменение: Полноэкранный GameDetailScreen вместо BottomSheet

**План:** Согласно dev.md (Stage 6 - Комментарии), предполагалось использовать BottomSheet для просмотра деталей игры.

**Решение:** Реализован полноэкранный `GameDetailScreen` вместо `_GameDetailSheet`.

**Причины:**
1. **UX улучшение** - полноэкранный просмотр позволяет показать больше информации без прокрутки
2. **Обложка игры** - SliverAppBar с FlexibleSpaceBar позволяет красиво отображать обложку с эффектом параллакса при скролле
3. **Редактирование** - диалоги редактирования комментариев лучше работают в контексте полноэкранного экрана
4. **Консистентность** - навигация через `Navigator.push()` соответствует паттерну остального приложения

### Изменение: Использование CachedNetworkImage для обложек

**Решение:** Используется `cached_network_image` пакет для кэширования обложек игр.

**Причины:**
1. **Производительность** - изображения кэшируются локально, не загружаются повторно
2. **UX** - placeholder при загрузке, graceful fallback при ошибках
3. **Оффлайн** - кэшированные изображения доступны без интернета

### Архитектурное решение: Передача isEditable через конструктор

**Решение:** `GameDetailScreen` получает `isEditable` через конструктор, а не вычисляет его из коллекции.

**Причины:**
1. **Производительность** - не требуется дополнительный запрос коллекции
2. **Single Source of Truth** - родительский экран уже знает состояние коллекции
3. **Тестируемость** - легко мокать в тестах

### Тестирование: Override collectionRepositoryProvider вместо NotifierProvider

**Проблема:** `collectionGamesNotifierProvider` не поддерживает прямой `overrideWith` в тестах.

**Решение:** Мокаем `collectionRepositoryProvider`, от которого зависит NotifierProvider.

**Причина:** Riverpod `AsyncNotifierProvider.family` не имеет метода `overrideWith` для семейных провайдеров. Мокирование репозитория - более чистый подход.

---

## Общие решения

### Локализация UI текстов

**Текущее состояние:** UI тексты захардкожены на английском.

**Причина:** Приоритет на функциональность. Локализация запланирована отдельным этапом.

---

## Ветки и PR

| Этап | Ветка | PR | Статус |
|------|-------|-----|--------|
| Stage 1 | - | - | Merged |
| Stage 2 | stage-2-game-search | #2 | Merged |
| Stage 3 | feature/stage-3-collections | #3 | Merged |
| Stage 4 | feature/stage-4-progress-tracking | #6 | Merged |
| Stage 5 | feature/stage-5-export-import | #7 | Merged |
| Fix Revert + Search | fix/revert-and-search | TBD | In Progress |
| Platform Logos | feature/platform-logos | TBD | Planned |

---

## Stage 5: Export/Import (2026-02-05)

### Формат .rcoll файла

**Решение:** Создан собственный JSON-based формат `.rcoll` для экспорта/импорта коллекций.

**Структура:**
```json
{
  "version": 1,
  "name": "Collection Name",
  "author": "username",
  "created": "2025-02-02T12:00:00Z",
  "description": null,
  "games": [
    {"igdb_id": 1234, "platform_id": 19, "comment": "..."}
  ]
}
```

**Причины:**
1. **Версионирование** - поле `version` позволяет обновлять формат с обратной совместимостью
2. **Минимализм** - сохраняем только IGDB ID, платформу и авторский комментарий
3. **Портируемость** - JSON читаем и редактируем в любом редакторе

### Архитектурное решение: Разделение на RcollFile, ExportService, ImportService

**Решение:** Три отдельных класса вместо одного сервиса.

**Причины:**
1. **Single Responsibility** - каждый класс имеет одну задачу
2. **Тестируемость** - RcollFile можно тестировать без файловой системы
3. **Переиспользование** - RcollFile используется и в Export, и в Import

### Импорт: Кэширование игр перед созданием коллекции

**Решение:** При импорте сначала загружаем данные игр из IGDB и кэшируем их в базу.

**Причины:**
1. **UX** - пользователь сразу видит обложки и информацию об играх
2. **Оффлайн** - после импорта коллекция работает без интернета
3. **Консистентность** - те же данные что и при добавлении игр вручную

### Обработка невалидной даты в .rcoll

**Решение:** При невалидном формате даты используется `DateTime.now()` вместо выброса исключения.

**Причина:** Graceful degradation - пользователь может импортировать файл с битой датой, это не критично для функциональности

---

## Доработка: Логотипы платформ и оффлайн режим (2026-02-05)

### Описание

Загрузка и отображение логотипов платформ из IGDB API с поддержкой оффлайн режима.

### Изменения

1. **IGDB API запрос** — добавлено поле `platform_logo.image_id` через field expansion
2. **Модель Platform** — добавлено поле `logoImageId` и getter `logoUrl`
3. **База данных** — миграция v4 для добавления колонки `logo_image_id`
4. **UI** — отображение логотипов в PlatformFilterSheet и диалоге выбора платформы
5. **Оффлайн кэш** — сервис для локального хранения изображений

### Технические детали

- URL формат IGDB: `https://images.igdb.com/igdb/image/upload/t_cover_big/{image_id}.png`
- Используется размер `cover_big` (227x320) — качественные логотипы
- Fallback на иконку если логотип недоступен

### Оффлайн режим (Image Cache)

**Файлы:**
- `lib/core/services/image_cache_service.dart` — сервис кэширования
- `lib/shared/widgets/cached_image.dart` — виджет для отображения

**Настройки (Settings → Image Cache):**
- **Галка "Offline mode"** — включает локальное сохранение изображений (по умолчанию выключено)
- **Cache folder** — путь к папке кэша, можно изменить через file picker
- **Clear** — очистка всего кэша

**Логика работы:**
1. **Галка выключена:** изображения загружаются из сети (IGDB CDN)
2. **Галка включена:**
   - При синхронизации платформ изображения скачиваются локально
   - Показываются только локальные файлы
   - Если файл отсутствует — показывается ошибка "Offline" (кэш повреждён)

**Структура кэша:**
```
{cache_folder}/
├── platform_logos/
│   ├── {image_id}.png
│   └── ...
└── game_covers/
    ├── {image_id}.png
    └── ...
```

**Типы изображений (ImageType):**
- `platformLogo` — логотипы платформ
- `gameCover` — обложки игр (подготовлено для будущего использования)
